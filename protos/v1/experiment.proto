syntax = "proto3";

package v1;

import "google/api/annotations.proto";
import "google/protobuf/empty.proto";
import "protoc-gen-swagger/options/annotations.proto";

import "v1/base.proto";
import "v1/code_ref.proto";

option (grpc.gateway.protoc_gen_swagger.options.openapiv2_swagger) = {
	info: {
		title: "Experiment service";
		version: "1.0";
		contact: {
			name: "Polyaxon experiment service";
			url: "https://github.com/polyaxon/polyaxon-sdks";
			email: "contact@polyaxon.com";
        };
    };
    schemes: HTTP;
    consumes: "application/json";
    produces: "application/json";
    responses: {
		key: "404";
		value: {
			description: "Resource does not exist.";
			schema: {
				json_schema: {
					type: STRING;
				}
			}
		}
	}
};

// Experiment specification
message Experiment {
    // Unique integer identifier
    int64 id = 1;

    // UUID
    string uuid = 2;

    // Unique name generated
    string unique_name = 3;

    // Optional name
    string name = 4;

    // Optional description
    string description = 5;

    // Optional Tags of this entity
    repeated string tags = 6;

    // Optional if the entity has been deleted
    bool deleted = 7;

    // Required name of user started this entity
    string user = 8;

    // Optional time when the entityt was created
    string created_at = 9;

    // Optional last time the entity was updated
    string updated_at = 10;

    // Optional last time the entity was started
    string started_at = 11;

    // Optional last time the entity was started
    string finished_at = 12;

    // Required project name
    string project = 13;

    // Optional flag to tell if this entity is managed by the platform
    string is_managed = 14;

    // Optional content of the entity's spec
    string spec = 15;

    // Optional backend value of this entity
    string backend = 16;

    // Optional framework name of this entity
    string framework = 17;

    // Optional latest status of this entity
    string last_status = 18;

    // Optional Code reference
    int64 code_reference = 19;

    // Optional hardware resources requested by this entity
    Dict resources = 20;

    // Optional a readme text describing this entity
    string readme = 21;

    // Optional if this entity was bookmarked
    bool bookmarked = 22;

    // Optional params of this entity
    Dict params = 23;

    // Optional run enivronment tracked
    Dict run_env = 24;

    // Optional build job name
    string build_job = 25;

    // Optional data references of this entity
    Dict data_refs = 26;

    // Optional artificat references of this entity
    Dict artifact_refs = 27;

    // Optional Id of the original experiment
    int64 original = 28;

    // Optional if this experiment was restarted/copied/resumed
    string cloning_strategy = 29;

    // Optional Experiment group name
    string experiment_group = 30;

    // Optional number of jobs belonging to this entity
    int32 num_jobs = 31;

    // Optional if this entity has a tensorboard
    bool has_tensorboard = 32;

    // Optional last metrics of this entity
    Dict last_metric = 33;
}

// Experiment specification
message ExperimentStatus {
    // Unique integer identifier
    int64 id = 1;

    // UUID
    string uuid = 2;

    // Optional time when the entityt was created
    string created_at = 3;

    // Optional last time the entity was updated
    string updated_at = 4;

    // Optional status recorded
    string status = 5; // Add oneof validation

    // Optional status message
    string message = 6;
}

// Request data to create/update experiment
message ExperimentBodyRequest{
    // Owner of the namespace
    string owner = 1;

    // Project where the experiement will be assigned
    string project = 2;

    // Experiment object
    Experiment experiment = 3;
}

 // Contains list experiments
 message ListExperimentsResponse{
    // Count of the entities
    int32 count = 1;

    // List of all entities
    repeated Experiment results = 2;

    // Previous page
    string previous = 3;

    // Next page
    string next = 4;
}


 // Contains list experiments
 message ListExperimentStatusesResponse{
    // Count of the entities
    int32 count = 1;

    // List of all entities
    repeated ExperimentStatus results = 2;

    // Previous page
    string previous = 3;

    // Next page
    string next = 4;
}


// Service to manage experiments
service ExperimentService {
    // List experiments
    rpc ListExperiments(ProjectBodyRequest) returns (ListExperimentsResponse) {
        option (google.api.http) = {
            get: "/v1/{owner}/{project}/experiments"
        };
    }

    // List bookmarked experiments
    rpc ListBookmarkedExperiments(OwnerBodyRequest) returns (ListExperimentsResponse) {
        option (google.api.http) = {
            get: "/v1/bookmarks/{owner}/experiments"
        };
    }

    // List archived experiments
    rpc ListArchivedExperiments(OwnerBodyRequest) returns (ListExperimentsResponse) {
        option (google.api.http) = {
            get: "/v1/archives/{owner}/experiments"
        };
    }

    // Create new experiment
    rpc CreateExperiment(ExperimentBodyRequest) returns (Experiment) {
        option (google.api.http) = {
            post: "/v1/{owner}/{project}/experiments"
            body: "*"
        };
    }

    // Get experiment
    rpc GetExperiment(OwnedEntityIdRequest) returns (Experiment) {
        option (google.api.http) = {
            get: "/v1/{owner}/{project}/experiments/{id}"
        };
    }

    // Update experiment
    rpc UpdateExperiment(ExperimentBodyRequest) returns (Experiment) {
        option (google.api.http) = {
            put: "/v1/{owner}/{project}/experiments/{experiment.id}"
            body: "*"

            additional_bindings {
                put: "/v1/{owner}/{project}/experiments/{experiment.id}"
                body: "*"
            }
        };
    }

    // Delete experiment
    rpc DeleteExperiment(OwnedEntityIdRequest) returns (google.protobuf.Empty) {
        option (google.api.http) = {
            delete: "/v1/{owner}/{project}/experiments/{id}"
        };
    }

    // Delete experiments
    rpc DeleteExperiments(OwnedEntityIdRequest) returns (google.protobuf.Empty) {
        option (google.api.http) = {
            delete: "/v1/{owner}/{project}/experiments/delete"
            body: "*"
        };
    }

    // Stop experiment
    rpc StopExperiment(OwnedEntityIdRequest) returns (google.protobuf.Empty) {
        option (google.api.http) = {
            post: "/v1/{owner}/{project}/experiments/{id}/stop"
            body: "*"
        };
    }

    // Stop experiments
    rpc StopExperiments(ProjectBodyRequest) returns (google.protobuf.Empty) {
        option (google.api.http) = {
            post: "/v1/{owner}/{project}/experiments/stop"
            body: "*"
        };
    }

    // Restart experiment
    rpc RestartExperiment(OwnedEntityIdRequest) returns (Experiment) {
        option (google.api.http) = {
            post: "/v1/{owner}/{project}/experiments/{id}/restart"
            body: "*"
        };
    }

    // Resume experiment
    rpc ResumeExperiment(OwnedEntityIdRequest) returns (Experiment) {
        option (google.api.http) = {
            post: "/v1/{owner}/{project}/experiments/{id}/resume"
            body: "*"
        };
    }

    // Archive experiment
    rpc ArchiveExperiment(OwnedEntityIdRequest) returns (google.protobuf.Empty) {
        option (google.api.http) = {
            post: "/v1/{owner}/{project}/experiments/{id}/archive"
        };
    }

    // Restore experiment
    rpc RestoreExperiment(OwnedEntityIdRequest) returns (google.protobuf.Empty) {
        option (google.api.http) = {
            post: "/v1/{owner}/{project}/experiments/{id}/restore"
        };
    }

    // Bookmark experiment
    rpc BookmarkExperiment(OwnedEntityIdRequest) returns (google.protobuf.Empty) {
        option (google.api.http) = {
            post: "/v1/{owner}/{project}/experiments/{id}/bookmark"
        };
    }

    // UnBookmark experiment
    rpc UnBookmarkExperiment(OwnedEntityIdRequest) returns (google.protobuf.Empty) {
        option (google.api.http) = {
            delete: "/v1/{owner}/{project}/experiments/{id}/unbookmark"
        };
    }

    // Start experiment tensorboard
    rpc StartExperimentTensorboard(OwnedEntityIdRequest) returns (google.protobuf.Empty) {  // TODO: should be a tensorboard object
        option (google.api.http) = {
            post: "/v1/{owner}/{project}/experiments/{id}/tensorboard/start"
            body: "*"
        };
    }

    // Stop experiment tensorboard
    rpc StopExperimentTensorboard(OwnedEntityIdRequest) returns (google.protobuf.Empty) {
        option (google.api.http) = {
            delete: "/v1/{owner}/{project}/experiments/{id}/tensorboard/stop"
        };
    }

    // Get experiment status
    rpc GetExperimentStatuses(OwnedEntityIdRequest) returns (StatusResponse) {
        option (google.api.http) = {
            get: "/v1/{owner}/{project}/experiments/{id}/statuses"
        };
    }

    // List experiment statuses
    rpc ListExperimentStatuses(OwnedEntityIdRequest) returns (ListExperimentStatusesResponse) {
        option (google.api.http) = {
            get: "/v1/{owner}/{project}/experiments/{id}/statuses"
        };
    }

    // Create new experiment status
    rpc CreateExperimentStatus(OwnedEntityIdRequest) returns (ExperimentStatus) {
        option (google.api.http) = {
            post: "/v1/{owner}/{project}/experiments/{id}/statuses"
            body: "*"
        };
    }

    // Get experiment code ref
    rpc GetExperimentCodeRef(OwnedEntityIdRequest) returns (CodeReference) {
        option (google.api.http) = {
            get: "/v1/{owner}/{project}/experiments/{id}/coderef"
        };
    }

    // Get experiment code ref
    rpc GreateExperimentCodeRef(CodeReferenceBodyRequest) returns (CodeReference) {
        option (google.api.http) = {
            post: "/v1/{entity.owner}/{entity.project}/experiments/{entity.id}/coderef"
            body: "*"
        };
    }
}
