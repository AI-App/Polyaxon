---
version: 0.6

kind: pipeline

name: test-build-run

tags:
  backend: native

ops:
  - name: build
    template: {name: build-template}
    params:
      env_vars: [["env1", "value1"], ["env2", "value2"]]
  - name: run
    template: {name: experiment-template}
    dependencies: [build]
    params:
      image: "{{ ops.build.outputs.docker-image }}"
      lr : 0.001

templates:
  - kind: job
    name: experiment-template
    description: experiment to predict something
    tags:
      key: value
    inputs:
      - name: lr
        type: float
        value: 0.1
        is_optional: true
      - name: image
        type: str
    environment:
      resources: {requests: {cpu: 1}}
      node_selector: {polyaxon: experiments}
      service_account: service
      image_pull_secrets: [secret1, secret2]
    termination:
      max_retries: 2
    container:
      image: "{{ image }}"
      command: [python3, main.py]
      args: "--lr={{ lr }}"

  - kind: job
    name: build-template
    description: build images
    tags:
      key: value
    inputs:
    - name: env_vars
      type: list
      is_list: true
    outputs:
    - name: docker-image
      type: str
    environment:
      resources: {requests: {cpu: 1}}
      node_selector: {polyaxon: experiments}
      service_account: service
      image_pull_secrets: [secret1, secret2]
    termination:
      max_retries: 2
    contexts:
      build:
        image: base
        env_vars: "{{ env_vars }}"
    container: {image: base}
